services:
  traefik:
    container_name: traefik
    image: traefik:v3.6
    command:
      - --log.level=DEBUG
      - --accesslog=true
      - --api.dashboard=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=traefik_web
      - --certificatesresolvers.le.acme.email=xp.vit.blr@gmail.com
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.le.acme.httpchallenge=true
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web
    labels:
      - "traefik.enable=true"
      # Define global redirect middleware
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./letsencrypt:/letsencrypt
    networks:
      - web
    restart: unless-stopped

  zaqlick-social-data-parser:
    container_name: data-parser
    image: xpvit/zaqlick-social-data-parser:${ZAQLICK_SOCIAL_DATA_PARSER_VERSION:-latest}
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_web"
      # Service definition
      - "traefik.http.services.parser.loadbalancer.server.port=8080"
      # HTTPS router
      - "traefik.http.routers.parser.rule=Host(`data.patotski.com`)"
      - "traefik.http.routers.parser.entrypoints=websecure"
      - "traefik.http.routers.parser.tls.certresolver=le"
      - "traefik.http.routers.parser.service=parser"
      # HTTP router (redirects to HTTPS)
      - "traefik.http.routers.parser-http.rule=Host(`data.patotski.com`)"
      - "traefik.http.routers.parser-http.entrypoints=web"
      - "traefik.http.routers.parser-http.middlewares=redirect-to-https"
    ports:
      - "8080:8080"
    networks:
      - web
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: prod
    volumes:
      - ./social-data-app/application.yaml:/workspace/application-prod.yaml

  zaqlick-app:
    container_name: zaqlick-app
    image: api.repoflow.io/xpvitblr-504/zaqlick-app/zaqlick-app:${ZAQLICK_APP_VERSION:-latest}
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_web"
      # Service definition for main app (port 8080)
      - "traefik.http.services.zaqlick.loadbalancer.server.port=8080"
      # HTTPS router for main app
      - "traefik.http.routers.zaqlick.rule=Host(`app2.zaqlick.com`)"
      - "traefik.http.routers.zaqlick.entrypoints=websecure"
      - "traefik.http.routers.zaqlick.tls.certresolver=le"
      - "traefik.http.routers.zaqlick.service=zaqlick"
      # HTTP router for main app (redirects to HTTPS)
      - "traefik.http.routers.zaqlick-http.rule=Host(`app2.zaqlick.com`)"
      - "traefik.http.routers.zaqlick-http.entrypoints=web"
      - "traefik.http.routers.zaqlick-http.middlewares=redirect-to-https"
      - "traefik.http.routers.zaqlick-http.service=zaqlick"
      # Service definition for jobs dashboard (port 8000)
      - "traefik.http.services.zaqlick-jobs.loadbalancer.server.port=8000"
      # HTTPS router for jobs dashboard
      - "traefik.http.routers.zaqlick-jobs.rule=Host(`jobs.zaqlick.com`)"
      - "traefik.http.routers.zaqlick-jobs.entrypoints=websecure"
      - "traefik.http.routers.zaqlick-jobs.tls.certresolver=le"
      - "traefik.http.routers.zaqlick-jobs.service=zaqlick-jobs"
      # HTTP router for jobs dashboard (redirects to HTTPS)
      - "traefik.http.routers.zaqlick-jobs-http.rule=Host(`jobs.zaqlick.com`)"
      - "traefik.http.routers.zaqlick-jobs-http.entrypoints=web"
      - "traefik.http.routers.zaqlick-jobs-http.middlewares=redirect-to-https"
      - "traefik.http.routers.zaqlick-jobs-http.service=zaqlick-jobs"
    ports:
      - "8889:8080"
      - "8000:8000"
    networks:
      - web
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: prod
    volumes:
      - ./zaqlick-app/application.yaml:/app/resources/application.properties

networks:
  web:
    name: traefik_web
    driver: bridge
