name: Update Image Version and Deploy

on:
  # Run on push to main branch
  push:
    branches:
      - main
  # Triggered by other repositories via repository_dispatch
  repository_dispatch:
    types: [update-image]
  
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      version_var:
        description: 'Environment variable name (e.g., ZAQLICK_SOCIAL_DATA_PARSER_VERSION). Leave empty to just redeploy.'
        required: false
        type: string
      image_tag:
        description: 'New image tag/version (e.g., v1.2.3 or latest). Leave empty to just redeploy.'
        required: false
        type: string

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set variables from dispatch event
        id: vars
        run: |
          # Handle both repository_dispatch and workflow_dispatch
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "version_var=${{ github.event.client_payload.version_var }}" >> $GITHUB_OUTPUT
            echo "image_tag=${{ github.event.client_payload.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "version_var=${{ inputs.version_var }}" >> $GITHUB_OUTPUT
            echo "image_tag=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Update .env file with new image version
        if: ${{ steps.vars.outputs.version_var != '' && steps.vars.outputs.image_tag != '' }}
        run: |
          VERSION_VAR="${{ steps.vars.outputs.version_var }}"
          IMAGE_TAG="${{ steps.vars.outputs.image_tag }}"
          
          echo "Updating variable: $VERSION_VAR"
          echo "New version: $IMAGE_TAG"
          
          # Update the version in .env file
          if grep -q "^${VERSION_VAR}=" .env; then
            # Variable exists, update it
            sed -i "s|^${VERSION_VAR}=.*|${VERSION_VAR}=${IMAGE_TAG}|" .env
          else
            # Variable doesn't exist, add it
            echo "${VERSION_VAR}=${IMAGE_TAG}" >> .env
          fi
          
          echo "Updated .env file:"
          cat .env

      - name: Commit and push changes
        if: ${{ steps.vars.outputs.version_var != '' && steps.vars.outputs.image_tag != '' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are any changes
          if git diff --quiet .env; then
            echo "No changes to commit"
          else
            git add .env
            git commit -m "chore: update ${{ steps.vars.outputs.version_var }} to ${{ steps.vars.outputs.image_tag }}"
            git push
          fi

      - name: Skip .env update (redeploy only)
        if: ${{ steps.vars.outputs.version_var == '' || steps.vars.outputs.image_tag == '' }}
        run: |
          echo "No version_var or image_tag provided, skipping .env update"
          echo "Proceeding with redeploy only..."

      - name: Install envsubst
        run: |
          sudo apt-get update
          sudo apt-get install -y gettext-base

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ vars.EC2_HOST }}" >> ~/.ssh/known_hosts
          ssh-keyscan -H "${{ vars.EC2_HOST_2 }}" >> ~/.ssh/known_hosts

      - name: Ensure directories exist on server
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }} "mkdir -p /home/${{ vars.EC2_USER }}/deploy/zaqlick-app"
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }} "mkdir -p /home/${{ vars.EC2_USER }}/deploy/stock-app"
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }} "mkdir -p /home/${{ vars.EC2_USER }}/deploy/social-data-app"
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes ${{ vars.EC2_USER }}@${{ vars.EC2_HOST_2 }} "mkdir -p /home/${{ vars.EC2_USER }}/deploy/zaqlick-app"

      - name: Generate application properties file for zaqlick
        env:
          ZAQLICK_DB_URL: ${{ vars.ZAQLICK_DB_URL }}
          ZAQLICK_DB_USER: ${{ secrets.ZAQLICK_DB_USER }}
          ZAQLICK_DB_PASSWORD: ${{ secrets.ZAQLICK_DB_PASSWORD }}
          ZAQLICK_APP_BASE_URL: ${{ vars.ZAQLICK_APP_BASE_URL }}
          ZAQLICK_MAILGUN_API_KEY: ${{ secrets.ZAQLICK_MAILGUN_API_KEY }}
          ZAQLICK_MAILGUN_DOMAIN: ${{ vars.ZAQLICK_MAILGUN_DOMAIN }}
          ZAQLICK_MAILGUN_FROM_EMAIL: ${{ vars.ZAQLICK_MAILGUN_FROM_EMAIL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -f zaqlick-app/application.yaml.template ]; then
            envsubst < zaqlick-app/application.yaml.template > zaqlick-app/application.yaml
          fi
      - name: Generate application properties file for social-data
        env:
          SOCIAL_DATA_DB_URL: ${{ vars.SOCIAL_DATA_DB_URL }}
          SOCIAL_DATA_DB_USER: ${{ secrets.SOCIAL_DATA_DB_USER }}
          SOCIAL_DATA_DB_PASSWORD: ${{ secrets.SOCIAL_DATA_DB_PASSWORD }}
        run: |
          if [ -f social-data-app/application.yaml.template ]; then
            envsubst < social-data-app/application.yaml.template > social-data-app/application.yaml
          fi
      

      - name: Copy docker-compose.yml and application properties files to server
        run: |
          scp -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes ./docker-compose.yml ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }}:/home/${{ vars.EC2_USER }}/deploy/docker-compose.yml
          scp -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes ./.env ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }}:/home/${{ vars.EC2_USER }}/deploy/.env
          if [ -f ./zaqlick-app/application.yaml ]; then
            scp -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes ./zaqlick-app/application.yaml ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }}:/home/${{ vars.EC2_USER }}/deploy/zaqlick-app/application.yaml
          fi
          if [ -f ./social-data-app/application.yaml ]; then
            scp -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes ./social-data-app/application.yaml ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }}:/home/${{ vars.EC2_USER }}/deploy/social-data-app/application.yaml
          fi
          if [ -f ./stock-app/application.yaml ]; then
            scp -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes ./stock-app/application.yaml ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }}:/home/${{ vars.EC2_USER }}/deploy/stock-app/application.yaml
          fi

      - name: Copy application config to worker node (zaqlick-app-2)
        run: |
          if [ -f ./zaqlick-app/application.yaml ]; then
            scp -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes ./zaqlick-app/application.yaml ${{ vars.EC2_USER }}@${{ vars.EC2_HOST_2 }}:/home/${{ vars.EC2_USER }}/deploy/zaqlick-app/application.yaml
          fi

      - name: Global Docker login on server
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USER }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_HOST: ${{ secrets.DOCKER_HOST }}
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }} \
            "docker login -u \"${DOCKER_USER}\" -p \"${DOCKER_PASSWORD}\" \"${DOCKER_HOST}\""

      - name: Deploy on EC2
        run: |
          ssh -i ~/.ssh/id_ed25519 "${{ vars.EC2_USER }}@${{ vars.EC2_HOST }}" bash -s <<'EOF'
          set -e
          cd ~/deploy

          # Initialize Swarm if not already active
          docker info --format '{{.Swarm.LocalNodeState}}' | grep -qx "active" || docker swarm init

          # One-time migration: remove old bridge network if it conflicts with the new overlay
          if docker network inspect traefik_web --format '{{.Driver}}' 2>/dev/null | grep -qx "bridge"; then
            echo "Removing old bridge network for Swarm migration..."
            docker ps -aq --filter "network=traefik_web" | xargs -r docker rm -f 2>/dev/null || true
            docker network rm traefik_web 2>/dev/null || true
          fi

          echo "Deploying stack..."
          docker stack deploy --with-registry-auth --compose-file docker-compose.yml patotski

          echo "Cleaning up unused images..."
          docker image prune -af

          echo "Deployment completed successfully!"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/id_ed25519
